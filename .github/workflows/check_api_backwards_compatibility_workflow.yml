name: API Compatibility Check

on:
  push:
    branches:
      - "pull-request/[0-9]+"
    paths:
      - 'megatron/core/**/*.py'
      - '!megatron/core/tests/**'
      - '!megatron/legacy/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      baseline:
        description: 'Baseline git reference (tag/branch)'
        required: true

jobs:
  check-compatibility:
    name: Check API Backward Compatibility
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to access baseline ref
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install griffe
        run: |
          python -m pip install --upgrade pip
          python -m pip install griffe
          python -c "import griffe; print('Griffe installed successfully')"
          python -c "from griffe import Object; print('Object import successful')" || echo "Object import from griffe failed"
          python -c "from griffe.dataclasses import Object; print('Object import from dataclasses successful')" || echo "Object import from dataclasses failed"
      
      - name: Determine baseline reference
        id: baseline
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Use manually specified baseline
            BASELINE="${{ github.event.inputs.baseline }}"
          else
            # Auto-detect latest core release tag (stable versions only, no rc)
            BASELINE=$(git tag -l 'core_v*' | grep -E '^core_v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
            
            # Error out if no tags found
            if [ -z "$BASELINE" ]; then
              echo "Error: No core_v* release tags found. Cannot determine baseline." >&2
              exit 1
            fi
          fi
          
          echo "baseline=$BASELINE" >> $GITHUB_OUTPUT
          echo "Using baseline: $BASELINE"
      
      - name: Run compatibility check
        id: compat_check
        run: |
          python scripts/check_api_backwards_compatibility.py \
            --baseline ${{ steps.baseline.outputs.baseline }} \
            --verbose
        continue-on-error: true
      
      - name: Fail job if breaking changes detected
        if: steps.compat_check.outcome == 'failure'
        run: |
          echo "::error::Breaking API changes detected. See logs above for details."
          exit 1
      
      - name: Success message
        if: steps.compat_check.outcome == 'success'
        run: |
          echo "::notice::âœ… No breaking API changes detected!"

