name: API Compatibility Check

on:
  push:
    branches:
      - "pull-request/[0-9]+"
    paths:
      - 'megatron/core/**/*.py'
      - '!megatron/core/tests/**'
      - '!megatron/legacy/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      baseline:
        description: 'Baseline git reference (tag/branch/commit)'
        required: true

jobs:
  check-compatibility:
    name: Check API Backward Compatibility
    runs-on: ubuntu-latest
    
    # ============================================================================
    # Configuration Parameters (modify here)
    # ============================================================================
    env:
      # Default baseline for automatic PR checks
      # Can be: branch name (e.g., 'main'), commit hash, or tag
      # Will be resolved to commit hash during execution
      DEFAULT_BASELINE: '712dff880cdf88e51289ad71e47d92f46d25a2d3'
      # Tag pattern for auto-detection (e.g., 'core_r*', 'core_v*')
      TAG_PATTERN: 'core_v*'
      # Tag regex filter (e.g., '^core_v[0-9]+\.[0-9]+\.[0-9]+$' for stable versions only)
      TAG_REGEX_FILTER: '^core_v[0-9]+\.[0-9]+\.[0-9]+$'
    # ============================================================================
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to access baseline ref
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install griffe
        run: |
          python -m pip install --upgrade pip
          python -m pip install griffe
          python -c "import griffe; print('Griffe installed successfully')"
          python -c "from griffe import Object; print('Object import successful')" || echo "Object import from griffe failed"
          python -c "from griffe.dataclasses import Object; print('Object import from dataclasses successful')" || echo "Object import from dataclasses failed"
      
      - name: Determine baseline reference
        id: baseline
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Use manually specified baseline (branch, tag, or commit hash)
            BASELINE_REF="${{ github.event.inputs.baseline }}"
          else
            # Use the configured default baseline
            BASELINE_REF="${{ env.DEFAULT_BASELINE }}"
            
            # Uncomment below to auto-detect from tags instead:
            # BASELINE_REF=$(git tag -l '${{ env.TAG_PATTERN }}' | grep -E '${{ env.TAG_REGEX_FILTER }}' | sort -V | tail -1)
            # if [ -z "$BASELINE_REF" ]; then
            #   echo "Warning: No tags matching pattern found. Using default: ${{ env.DEFAULT_BASELINE }}" >&2
            #   BASELINE_REF="${{ env.DEFAULT_BASELINE }}"
            # fi
          fi
          
          # Resolve baseline to commit hash (works for branches, tags, or commit hashes)
          BASELINE_HASH=$(git rev-parse "$BASELINE_REF")
          
          echo "baseline=$BASELINE_HASH" >> $GITHUB_OUTPUT
          echo "Using baseline: $BASELINE_REF (resolved to commit: $BASELINE_HASH)"
      
      - name: Run compatibility check
        id: compat_check
        run: |
          # Save output to file for later display
          python scripts/check_api_backwards_compatibility.py \
            --baseline ${{ steps.baseline.outputs.baseline }} \
            --verbose 2>&1 | tee compat_check_output.txt
          
          # Capture exit code
          EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
        continue-on-error: true
      
      - name: Fail job if breaking changes detected
        if: steps.compat_check.outcome == 'failure'
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” WHAT IS THIS CHECK?"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "This check ensures that changes to Megatron Core's public API do not"
          echo "break backward compatibility for users. It compares your PR against"
          echo "the latest stable release to detect breaking changes in:"
          echo ""
          echo "  â€¢ Function signatures (parameters, order, types)"
          echo "  â€¢ Class structures and methods"
          echo "  â€¢ Return types and public interfaces"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ› ï¸  HOW TO FIX THIS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Choose ONE of these resolution strategies:"
          echo ""
          echo "1ï¸âƒ£  REVERT THE BREAKING CHANGE (Recommended)"
          echo "   â†’ Modify your code to preserve backward compatibility"
          echo "   â†’ Add new parameters as optional (with defaults)"
          echo "   â†’ Keep existing parameters in the same order"
          echo ""
          echo "2ï¸âƒ£  MARK AS INTERNAL API (If this is internal code)"
          echo "   â†’ Add @internal_api decorator from megatron.core.utils"
          echo ""
          echo "   Example (for classes):"
          echo "      from megatron.core.utils import internal_api"
          echo ""
          echo "      @internal_api"
          echo "      class ExperimentalFeature:"
          echo "          pass"
          echo ""
          echo "   Example (for functions):"
          echo "      from megatron.core.utils import internal_api"
          echo ""
          echo "      @internal_api"
          echo "      def internal_helper_function():"
          echo "          pass"
          echo ""
          echo "3ï¸âƒ£  USE DEPRECATION (For gradual API changes)"
          echo "   â†’ Add @deprecated decorator for transition period"
          echo "   â†’ Example:"
          echo "      from megatron.core.utils import deprecated"
          echo ""
          echo "      @deprecated(version='1.0', removal_version='2.0',"
          echo "                  alternative='new_function')"
          echo "      def old_function():"
          echo "          pass"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ BREAKING CHANGES DETECTED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          cat compat_check_output.txt
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“š MORE INFORMATION"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“– Full documentation: docs/api-backwards-compatibility-check.md"
          echo "ğŸ”§ Checker script: scripts/check_api_backwards_compatibility.py"
          echo "â“ Questions? Check the docs or ask in #megatron-core"
          echo ""
          
          echo "::error::Breaking API changes detected. Please review the output above and choose a resolution strategy."
          exit 1
      
      - name: Success message
        if: steps.compat_check.outcome == 'success'
        run: |
          echo "::notice::âœ… No breaking API changes detected!"

