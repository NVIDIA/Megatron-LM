name: "Codeowners Approval Workflow"

on:
  push:
    branches:
      - "pull-request/[0-9]+"
  merge_group:
    types: [checks_requested]

jobs:
  pre-flight:
    uses: NVIDIA-NeMo/FW-CI-templates/.github/workflows/_cicd_preflight.yml@v0.65.5
    if: github.repository == 'NVIDIA/Megatron-LM'

  codeowners-approval:
    needs: [pre-flight]
    runs-on: ubuntu-latest
    environment: nemo-ci
    if: |
      !(needs.pre-flight.outputs.docs_only == 'true'
      || needs.pre-flight.outputs.is_merge_group == 'true'
      || needs.pre-flight.outputs.is_deployment_workflow == 'true')
    steps:
      - name: Get PR info
        id: get-pr-info
        if: startsWith(github.ref, 'refs/heads/pull-request/')
        uses: nv-gha-runners/get-pr-info@main

      - name: Check for complexity:low label and core paths
        id: check-conditions
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          PR_INFO: ${{ steps.get-pr-info.outputs.pr-info }}
          PR_NUMBER: ${{ fromJSON(steps.get-pr-info.outputs.pr-info || '{}').number }}
        run: |
          # Check for complexity:low label
          if echo "$PR_INFO" | jq -e '.labels[]? | select(.name == "complexity: low")' > /dev/null 2>&1; then
            echo "is_low_complexity=true" >> $GITHUB_OUTPUT
          else
            echo "is_low_complexity=false" >> $GITHUB_OUTPUT
          fi

          # Check if any changed files are in megatron/core or megatron/training
          CHANGED_FILES=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/files --jq '.[].filename')
          if echo "$CHANGED_FILES" | grep -qE '^megatron/(core|training)/'; then
            echo "has_core_changes=true" >> $GITHUB_OUTPUT
            echo "PR has changes in megatron/core or megatron/training"
          else
            echo "has_core_changes=false" >> $GITHUB_OUTPUT
            echo "PR does not have changes in megatron/core or megatron/training"
          fi

      - name: Request reviews from required teams
        if: steps.check-conditions.outputs.has_core_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          PR_NUMBER: ${{ fromJSON(steps.get-pr-info.outputs.pr-info || '{}').number }}
          IS_LOW_COMPLEXITY: ${{ steps.check-conditions.outputs.is_low_complexity }}
        run: |
          # Request core-nemo for core changes
          gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/requested_reviewers \
            --method POST -f team_reviewers[]="core-nemo" 2>/dev/null || true

          # Request core-adlr unless complexity:low
          if [ "$IS_LOW_COMPLEXITY" != "true" ]; then
            gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/requested_reviewers \
              --method POST -f team_reviewers[]="core-adlr" 2>/dev/null || true
          fi

      - name: Check core-nemo approval (required for core changes)
        if: steps.check-conditions.outputs.has_core_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          PR_NUMBER: ${{ fromJSON(steps.get-pr-info.outputs.pr-info || '{}').number }}
        run: |
          # Get team members
          MEMBERS=$(gh api orgs/NVIDIA/teams/core-nemo/members --jq '.[].login' 2>/dev/null || echo "")
          if [ -z "$MEMBERS" ]; then
            echo "Warning: Could not fetch core-nemo team members"
            exit 1
          fi

          # Get PR approvers
          APPROVERS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
            --jq '[.[] | select(.state == "APPROVED")] | [.[].user.login] | unique | .[]')

          # Check if any team member approved
          for member in $MEMBERS; do
            if echo "$APPROVERS" | grep -q "^${member}$"; then
              echo "✅ core-nemo approval found from: $member"
              exit 0
            fi
          done

          echo "❌ Missing approval from @NVIDIA/core-nemo"
          exit 1

      - name: Check core-adlr approval (required for core changes unless complexity:low)
        if: steps.check-conditions.outputs.has_core_changes == 'true' && steps.check-conditions.outputs.is_low_complexity != 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT }}
          PR_NUMBER: ${{ fromJSON(steps.get-pr-info.outputs.pr-info || '{}').number }}
        run: |
          # Get team members
          MEMBERS=$(gh api orgs/NVIDIA/teams/core-adlr/members --jq '.[].login' 2>/dev/null || echo "")
          if [ -z "$MEMBERS" ]; then
            echo "Warning: Could not fetch core-adlr team members"
            exit 1
          fi

          # Get PR approvers
          APPROVERS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
            --jq '[.[] | select(.state == "APPROVED")] | [.[].user.login] | unique | .[]')

          # Check if any team member approved
          for member in $MEMBERS; do
            if echo "$APPROVERS" | grep -q "^${member}$"; then
              echo "✅ core-adlr approval found from: $member"
              exit 0
            fi
          done

          echo "❌ Missing approval from @NVIDIA/core-adlr"
          exit 1

      - name: Checkout action
        uses: actions/checkout@v3
        with:
          repository: noamelf/codeowner-multi-approval-action
          ref: v0.1
          path: codeowner-multi-approval-action

      - name: Check Codeowners Approval
        uses: ./codeowner-multi-approval-action
        with:
          pr-number: ${{ fromJSON(steps.get-pr-info.outputs.pr-info || '{}').number }}
          repo-name: ${{ github.repository }}
          github-token: ${{ secrets.PAT }}

  multi-approval-bot-summary:
    needs: [pre-flight, codeowners-approval]
    if: |
      (
        needs.pre-flight.outputs.docs_only == 'true'
        || needs.pre-flight.outputs.is_merge_group == 'true'
        || needs.pre-flight.outputs.is_deployment_workflow == 'true'
        || always()
      )
      && github.repository == 'NVIDIA/Megatron-LM'
      && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Result
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          SKIPPING_IS_ALLOWED: ${{ needs.pre-flight.outputs.docs_only == 'true' || needs.pre-flight.outputs.is_deployment_workflow == 'true' || needs.pre-flight.outputs.is_merge_group == 'true' || needs.pre-flight.outputs.is_ci_workload == 'true' }}
        run: |
          FAILED_JOBS=$(gh run view $GITHUB_RUN_ID --json jobs --jq '[.jobs[] | select(.status == "completed" and .conclusion != "success")] | length') || echo 0

          if [ "${FAILED_JOBS:-0}" -eq 0 ] || [ "$SKIPPING_IS_ALLOWED" == "true" ]; then
              echo "✅ All previous jobs completed successfully"
              exit 0
          else
              echo "❌ Found $FAILED_JOBS failed job(s)"
              # Show which jobs failed
              gh run view $GITHUB_RUN_ID --json jobs --jq '.jobs[] | select(.status == "completed" and .conclusion != "success") | .name'
              exit 1
          fi
