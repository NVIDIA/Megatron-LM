# Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Trigger MBridge Tests
# Remote testing of MBridge from MCore
# Triggers MBridge CI tests with current MCore commit to verify backward compatibility

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      mbridge_ref:
        description: 'MBridge branch/ref to trigger'
        required: false
        type: string
        default: 'main'
      run_cicd_main:
        description: 'Run cicd-main.yml (full CI/CD)'
        required: false
        type: boolean
        default: true
      run_install_test:
        description: 'Run install-test.yml (quick install check)'
        required: false
        type: boolean
        default: true
      test_suite:
        description: 'Test suite to run (for cicd-main)'
        required: false
        type: choice
        options:
          - 'all'
          - 'unit-only'
          - 'functional-only'
        default: 'all'

jobs:
  # First job: Get MCore commit info (shared by all matrix jobs)
  get-mcore-info:
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.mcore_info.outputs.sha }}
      short_sha: ${{ steps.mcore_info.outputs.short_sha }}
      branch: ${{ steps.mcore_info.outputs.branch }}
    steps:
      - name: Checkout MCore
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get MCore commit info
        id: mcore_info
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

          echo "üì¶ MCore commit: $(git rev-parse --short HEAD)"
          echo "üåø Branch: ${GITHUB_REF#refs/heads/}"

  # Matrix job: Trigger and monitor MBridge workflows in parallel
  trigger-and-monitor:
    needs: [get-mcore-info]
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail workflow if monitoring times out
    strategy:
      fail-fast: false  # Continue other matrix jobs even if one fails
      matrix:
        include:
          - workflow: install-test.yml
            name: Install Test
          - workflow: cicd-main.yml
            name: CI/CD Main
    
    name: ${{ matrix.name }}
    
    steps:
      - name: Check if workflow should run
        id: should_run
        run: |
          if [[ "${{ matrix.workflow }}" == "install-test.yml" && "${{ inputs.run_install_test }}" == "true" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.workflow }}" == "cicd-main.yml" && "${{ inputs.run_cicd_main }}" == "true" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping ${{ matrix.workflow }} (not enabled)"
          fi
      
      - name: Trigger MBridge ${{ matrix.workflow }}
        if: steps.should_run.outputs.run == 'true'
        id: trigger
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üöÄ Triggering ${{ matrix.workflow }} | MCore: ${{ needs.get-mcore-info.outputs.sha }} | MBridge: ${{ inputs.mbridge_ref }}"
          
          gh workflow run ${{ matrix.workflow }} \
            --repo NVIDIA-NeMo/Megatron-Bridge --ref ${{ inputs.mbridge_ref }} \
            --field mcore_commit=${{ needs.get-mcore-info.outputs.sha }} \
            --field mcore_branch=${{ needs.get-mcore-info.outputs.branch }} \
            --field test_suite=${{ inputs.test_suite }} \
            --field triggered_by=mcore-ci
      
      - name: Wait for workflow to start and capture run ID
        if: steps.should_run.outputs.run == 'true'
        id: get_run_id
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "‚è≥ Waiting for triggered workflow to appear..."
          sleep 10
          
          echo "üîç Looking for ${{ matrix.workflow }} run..."
          RUN_ID=$(gh run list \
            --repo NVIDIA-NeMo/Megatron-Bridge \
            --workflow=${{ matrix.workflow }} \
            --limit 5 \
            --json databaseId,headSha,createdAt \
            --jq "sort_by(.createdAt) | reverse | .[0] | .databaseId")
          
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT
          echo "üìã Run ID: ${RUN_ID}"
          
          printf "## üîÑ %s Triggered\n\n**MCore:** \`%s\` | **MBridge:** \`%s\` | **Suite:** \`%s\`\n\n- üîÑ [%s](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/%s) - Running...\n- ‚è≥ Polling every 5 minutes until completion or GHA timeout\n\n> **Note:** If tests exceed GitHub Actions' timeout, monitoring stops gracefully.\n" \
            "${{ matrix.name }}" \
            "${{ needs.get-mcore-info.outputs.short_sha }}" \
            "${{ inputs.mbridge_ref }}" \
            "${{ inputs.test_suite }}" \
            "${{ matrix.workflow }}" \
            "${RUN_ID}" \
            >> $GITHUB_STEP_SUMMARY

      - name: Monitor workflow  
        if: steps.should_run.outputs.run == 'true'
        id: monitor
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            const runId = ${{ steps.get_run_id.outputs.run_id }};
            const checkInterval = 300000; // 5 minutes
            
            console.log(`üìä Monitoring ${{ matrix.workflow }} (Run ID: ${runId})`);
            
            // Poll until completion or GitHub Actions timeout
            while (true) {
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner: 'NVIDIA-NeMo',
                repo: 'Megatron-Bridge',
                run_id: runId,
              });
              
              console.log(`Status: ${run.status}, Conclusion: ${run.conclusion}`);
              
              if (run.status === 'completed') {
                core.exportVariable('workflow_status', run.conclusion);
                console.log(`‚úÖ ${{ matrix.name }} completed with status: ${run.conclusion}`);
                return run.conclusion;
              }
              
              console.log(`‚è≥ Still running... next check in ${checkInterval / 1000}s`);
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }

      - name: Report results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          RUN_ID="${{ steps.get_run_id.outputs.run_id }}"
          CONCLUSION=$(gh run view ${RUN_ID} --repo NVIDIA-NeMo/Megatron-Bridge --json conclusion --jq -r .conclusion 2>/dev/null || echo "unknown")
          
          case "$CONCLUSION" in
            "success") ICON="‚úÖ" ;;
            "failure") ICON="‚ùå" ;;
            "cancelled") ICON="üö´" ;;
            *) ICON="‚è≥" ;;
          esac
          
          printf "## üìä %s Results\n\n### %s %s\n**Status:** \`%s\`\n\n[View full results ‚Üí](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/%s)\n\n---\n*Triggered from MCore commit \`%s\`*\n" \
            "${{ matrix.name }}" \
            "${ICON}" \
            "${{ matrix.workflow }}" \
            "${CONCLUSION}" \
            "${RUN_ID}" \
            "${{ needs.get-mcore-info.outputs.short_sha }}" \
            >> $GITHUB_STEP_SUMMARY
          
          # Report status to console
          if [ "$CONCLUSION" == "failure" ]; then
            echo "‚ùå ${{ matrix.name }} failed - check link above"
            exit 1
          elif [ "$CONCLUSION" == "success" ]; then
            echo "‚úÖ ${{ matrix.name }} passed"
          else
            echo "‚è≥ ${{ matrix.name }} still running or monitoring timed out. Check the link in the summary above."
          fi
