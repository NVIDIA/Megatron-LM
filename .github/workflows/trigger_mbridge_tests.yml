# Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

name: Trigger MBridge Tests
# Remote testing of MBridge from MCore
# Triggers MBridge CI tests with current MCore commit to verify backward compatibility

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      mbridge_ref:
        description: 'MBridge branch/ref to trigger'
        required: false
        type: string
        default: 'main'
      run_cicd_main:
        description: 'Run cicd-main.yml (full CI/CD)'
        required: false
        type: boolean
        default: true
      run_install_test:
        description: 'Run install-test.yml (quick install check)'
        required: false
        type: boolean
        default: true
      test_suite:
        description: 'Test suite to run (for cicd-main)'
        required: false
        type: choice
        options:
          - 'all'
          - 'unit-only'
          - 'functional-only'
        default: 'all'

jobs:
  trigger-mbridge:
    runs-on: ubuntu-latest
    outputs:
      install_test_run_id: ${{ steps.wait_for_runs.outputs.install_test_run_id }}
      cicd_main_run_id: ${{ steps.wait_for_runs.outputs.cicd_main_run_id }}
      mcore_commit: ${{ steps.mcore_info.outputs.short_sha }}
    steps:
      - name: Checkout MCore
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get MCore commit info
        id: mcore_info
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

          echo "üì¶ MCore commit: $(git rev-parse --short HEAD)"
          echo "üåø Branch: ${GITHUB_REF#refs/heads/}"
      
      - name: Trigger MBridge install-test.yml
        if: ${{ inputs.run_install_test }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üöÄ Triggering MBridge workflow: install-test.yml"
          echo "üìå MCore commit: ${{ steps.mcore_info.outputs.sha }}"
          echo "üåø MBridge ref: ${{ inputs.mbridge_ref }}"
          
          gh workflow run install-test.yml \
            --repo NVIDIA-NeMo/Megatron-Bridge --ref ${{ inputs.mbridge_ref }} \
            --field mcore_commit=${{ steps.mcore_info.outputs.sha }} \
            --field mcore_branch=${{ steps.mcore_info.outputs.branch }} \
            --field test_suite=${{ inputs.test_suite }} \
            --field triggered_by=mcore-ci
      
      - name: Trigger MBridge cicd-main.yml
        if: ${{ inputs.run_cicd_main }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "üöÄ Triggering MBridge workflow: cicd-main.yml"
          echo "üìå MCore commit: ${{ steps.mcore_info.outputs.sha }}"
          echo "üåø MBridge ref: ${{ inputs.mbridge_ref }}"
          
          gh workflow run cicd-main.yml \
            --repo NVIDIA-NeMo/Megatron-Bridge --ref ${{ inputs.mbridge_ref }} \
            --field mcore_commit=${{ steps.mcore_info.outputs.sha }} \
            --field mcore_branch=${{ steps.mcore_info.outputs.branch }} \
            --field test_suite=${{ inputs.test_suite }} \
            --field triggered_by=mcore-ci
      
      - name: Wait for workflows to start and capture run IDs
        id: wait_for_runs
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "‚è≥ Waiting for triggered workflows to appear..."
          sleep 10
          
          MCORE_SHA="${{ steps.mcore_info.outputs.sha }}"
          
          # Get install-test run ID
          if [ "${{ inputs.run_install_test }}" == "true" ]; then
            echo "üîç Looking for install-test.yml run..."
            INSTALL_RUN_ID=$(gh run list \
              --repo NVIDIA-NeMo/Megatron-Bridge \
              --workflow=install-test.yml \
              --limit 5 \
              --json databaseId,headSha,createdAt \
              --jq "sort_by(.createdAt) | reverse | .[0] | .databaseId")
            
            echo "install_test_run_id=${INSTALL_RUN_ID}" >> $GITHUB_OUTPUT
            echo "üìã Install test run ID: ${INSTALL_RUN_ID}"
          fi
          
          # Get cicd-main run ID
          if [ "${{ inputs.run_cicd_main }}" == "true" ]; then
            echo "üîç Looking for cicd-main.yml run..."
            CICD_RUN_ID=$(gh run list \
              --repo NVIDIA-NeMo/Megatron-Bridge \
              --workflow=cicd-main.yml \
              --limit 5 \
              --json databaseId,headSha,createdAt \
              --jq "sort_by(.createdAt) | reverse | .[0] | .databaseId")
            
            echo "cicd_main_run_id=${CICD_RUN_ID}" >> $GITHUB_OUTPUT
            echo "üìã CICD main run ID: ${CICD_RUN_ID}"
          fi
      
      - name: Initial Summary
        run: |
          {
            echo "## üîÑ MBridge Tests Triggered"
            echo ""
            echo "**MCore Commit:** \`${{ steps.mcore_info.outputs.short_sha }}\` | **MBridge Ref:** \`${{ inputs.mbridge_ref }}\` | **Test Suite:** \`${{ inputs.test_suite }}\`"
            echo ""
            if [ "${{ inputs.run_install_test }}" == "true" ]; then
              echo "- üîÑ [install-test.yml](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/${{ steps.wait_for_runs.outputs.install_test_run_id }}) - Running..."
            fi
            if [ "${{ inputs.run_cicd_main }}" == "true" ]; then
              echo "- üîÑ [cicd-main.yml](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/${{ steps.wait_for_runs.outputs.cicd_main_run_id }}) - Running..."
            fi
            echo ""
            echo "‚è≥ Monitoring test results (polling every 5 minutes until completion or GHA timeout)..."
            echo ""
            echo "> **Note:** If tests exceed GitHub Actions' job timeout limit, monitoring will stop gracefully. Click the links above to see final results anytime."
          } >> $GITHUB_STEP_SUMMARY

  monitor-results:
    needs: [trigger-mbridge]
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail workflow if monitoring times out
    if: always()
    steps:
      - name: Monitor install-test workflow (polling)
        if: ${{ inputs.run_install_test && needs.trigger-mbridge.outputs.install_test_run_id != '' }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          RUN_ID="${{ needs.trigger-mbridge.outputs.install_test_run_id }}"
          echo "üìä Monitoring install-test.yml (Run ID: ${RUN_ID})"
          
          POLL_INTERVAL=300  # Poll every 5 minutes
          MAX_POLLS=999999   # Effectively unlimited - let GHA timeout naturally
          POLL_COUNT=0
          
          while [ $POLL_COUNT -lt $MAX_POLLS ]; do
            STATUS_JSON=$(gh run view ${RUN_ID} --repo NVIDIA-NeMo/Megatron-Bridge --json status,conclusion)
            STATUS=$(echo "$STATUS_JSON" | jq -r .status)
            CONCLUSION=$(echo "$STATUS_JSON" | jq -r .conclusion)
            
            echo "[$POLL_COUNT] Status: $STATUS, Conclusion: $CONCLUSION"
            
            # Check if workflow completed
            if [ "$STATUS" == "completed" ]; then
              echo "install_test_status=${CONCLUSION}" >> $GITHUB_ENV
              echo "‚úÖ Install test completed with status: ${CONCLUSION}"
              break
            fi
            
            # Still running, wait before next poll
            POLL_COUNT=$((POLL_COUNT + 1))
            if [ $POLL_COUNT -lt $MAX_POLLS ]; then
              echo "‚è≥ Still running... next check in ${POLL_INTERVAL}s (${POLL_COUNT}/${MAX_POLLS})"
              sleep $POLL_INTERVAL
            fi
          done
          
          # If we exhausted all polls
          if [ $POLL_COUNT -eq $MAX_POLLS ]; then
            echo "‚è±Ô∏è Monitoring timeout reached - tests still running"
          fi

      - name: Monitor cicd-main workflow (polling)
        if: ${{ inputs.run_cicd_main && needs.trigger-mbridge.outputs.cicd_main_run_id != '' }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          RUN_ID="${{ needs.trigger-mbridge.outputs.cicd_main_run_id }}"
          echo "üìä Monitoring cicd-main.yml (Run ID: ${RUN_ID})"
          
          POLL_INTERVAL=300  # Poll every 5 minutes
          MAX_POLLS=999999   # Effectively unlimited - let GHA timeout naturally
          POLL_COUNT=0
          
          while [ $POLL_COUNT -lt $MAX_POLLS ]; do
            STATUS_JSON=$(gh run view ${RUN_ID} --repo NVIDIA-NeMo/Megatron-Bridge --json status,conclusion)
            STATUS=$(echo "$STATUS_JSON" | jq -r .status)
            CONCLUSION=$(echo "$STATUS_JSON" | jq -r .conclusion)
            
            echo "[$POLL_COUNT] Status: $STATUS, Conclusion: $CONCLUSION"
            
            # Check if workflow completed
            if [ "$STATUS" == "completed" ]; then
              echo "cicd_main_status=${CONCLUSION}" >> $GITHUB_ENV
              echo "‚úÖ CICD main completed with status: ${CONCLUSION}"
              break
            fi
            
            # Still running, wait before next poll
            POLL_COUNT=$((POLL_COUNT + 1))
            if [ $POLL_COUNT -lt $MAX_POLLS ]; then
              echo "‚è≥ Still running... next check in ${POLL_INTERVAL}s (${POLL_COUNT}/${MAX_POLLS})"
              sleep $POLL_INTERVAL
            fi
          done
          
          # If we exhausted all polls
          if [ $POLL_COUNT -eq $MAX_POLLS ]; then
            echo "‚è±Ô∏è Monitoring timeout reached - tests still running"
          fi

      - name: Get detailed test results
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "## üìä MBridge Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Install test results
          if [ "${{ inputs.run_install_test }}" == "true" ] && [ -n "${{ needs.trigger-mbridge.outputs.install_test_run_id }}" ]; then
            RUN_ID="${{ needs.trigger-mbridge.outputs.install_test_run_id }}"
            STATUS=$(gh run view ${RUN_ID} --repo NVIDIA-NeMo/Megatron-Bridge --json conclusion,status,headBranch,createdAt,updatedAt --jq .)
            CONCLUSION=$(echo "$STATUS" | jq -r .conclusion)
            
            case "$CONCLUSION" in
              "success") ICON="‚úÖ" ;;
              "failure") ICON="‚ùå" ;;
              "cancelled") ICON="üö´" ;;
              *) ICON="‚è≥" ;;
            esac
            
            echo "### ${ICON} install-test.yml" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** \`${CONCLUSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View full results ‚Üí](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/${RUN_ID})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # CICD main results
          if [ "${{ inputs.run_cicd_main }}" == "true" ] && [ -n "${{ needs.trigger-mbridge.outputs.cicd_main_run_id }}" ]; then
            RUN_ID="${{ needs.trigger-mbridge.outputs.cicd_main_run_id }}"
            STATUS=$(gh run view ${RUN_ID} --repo NVIDIA-NeMo/Megatron-Bridge --json conclusion,status,headBranch,createdAt,updatedAt --jq .)
            CONCLUSION=$(echo "$STATUS" | jq -r .conclusion)
            
            case "$CONCLUSION" in
              "success") ICON="‚úÖ" ;;
              "failure") ICON="‚ùå" ;;
              "cancelled") ICON="üö´" ;;
              *) ICON="‚è≥" ;;
            esac
            
            echo "### ${ICON} cicd-main.yml" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Status:** \`${CONCLUSION}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View full results ‚Üí](https://github.com/NVIDIA-NeMo/Megatron-Bridge/actions/runs/${RUN_ID})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Triggered from MCore commit \`${{ needs.trigger-mbridge.outputs.mcore_commit }}\`*" >> $GITHUB_STEP_SUMMARY

      - name: Report final status
        if: always()
        env:
          INSTALL_STATUS: ${{ env.install_test_status }}
          CICD_STATUS: ${{ env.cicd_main_status }}
        run: |
          echo "üìã Final Status Summary:"
          [ -n "$INSTALL_STATUS" ] && echo "  - install-test: $INSTALL_STATUS"
          [ -n "$CICD_STATUS" ] && echo "  - cicd-main: $CICD_STATUS"
          
          # Report status but don't fail workflow (continue-on-error handles this)
          if [ "$INSTALL_STATUS" == "failure" ] || [ "$CICD_STATUS" == "failure" ]; then
            echo "‚ùå One or more MBridge tests failed - check links above for details"
            exit 1
          elif [ "$INSTALL_STATUS" == "success" ] || [ "$CICD_STATUS" == "success" ]; then
            echo "‚úÖ All triggered MBridge tests passed"
          else
            echo "‚è≥ MBridge tests still running or monitoring timed out"
            echo "üí° This is expected for long-running tests - check the links in the summary above"
          fi
