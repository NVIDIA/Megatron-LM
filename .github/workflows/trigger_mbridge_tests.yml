# Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Trigger MBridge Tests

# Remote testing of MBridge from MCore
# This workflow triggers MBridge's CI tests with the current MCore commit
# to verify backward compatibility before merging MCore changes.

on:
  # Manual trigger only for POC
  workflow_dispatch:
    inputs:
      run_cicd_main:
        description: 'Run cicd-main.yml (full CI/CD)'
        required: false
        type: boolean
        default: true
      run_install_test:
        description: 'Run install-test.yml (quick install check)'
        required: false
        type: boolean
        default: true
      test_suite:
        description: 'Test suite to run (for cicd-main)'
        required: false
        type: choice
        options:
          - 'all'
          - 'unit-only'
          - 'functional-only'
        default: 'all'

jobs:
  trigger-mbridge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout MCore
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get MCore commit info
        id: mcore_info
        run: |
          MCORE_SHA=$(git rev-parse HEAD)
          MCORE_SHORT_SHA=$(git rev-parse --short HEAD)
          MCORE_BRANCH=${GITHUB_REF#refs/heads/}
          MCORE_PR_NUMBER=${{ github.event.pull_request.number }}
          
          echo "sha=$MCORE_SHA" >> $GITHUB_OUTPUT
          echo "short_sha=$MCORE_SHORT_SHA" >> $GITHUB_OUTPUT
          echo "branch=$MCORE_BRANCH" >> $GITHUB_OUTPUT
          echo "pr_number=$MCORE_PR_NUMBER" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ MCore commit: $MCORE_SHORT_SHA"
          echo "ðŸŒ¿ Branch: $MCORE_BRANCH"
          if [ -n "$MCORE_PR_NUMBER" ]; then
            echo "ðŸ”€ PR: #$MCORE_PR_NUMBER"
          fi
      
      - name: Trigger MBridge install-test.yml
        if: ${{ inputs.run_install_test }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "ðŸš€ Triggering MBridge workflow: install-test.yml"
          echo "ðŸ“Œ MCore commit: ${{ steps.mcore_info.outputs.sha }}"
          
          gh workflow run install-test.yml \
            --repo NVIDIA/Megatron-Bridge \
            --ref main \
            --field mcore_commit=${{ steps.mcore_info.outputs.sha }} \
            --field mcore_branch=${{ steps.mcore_info.outputs.branch }} \
            --field test_suite=${{ inputs.test_suite }} \
            --field triggered_by=mcore-ci
          
          echo "âœ… install-test.yml triggered successfully!"
      
      - name: Trigger MBridge cicd-main.yml
        if: ${{ inputs.run_cicd_main }}
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          echo "ðŸš€ Triggering MBridge workflow: cicd-main.yml"
          echo "ðŸ§ª Test suite: ${{ inputs.test_suite }}"
          echo "ðŸ“Œ MCore commit: ${{ steps.mcore_info.outputs.sha }}"
          
          gh workflow run cicd-main.yml \
            --repo NVIDIA/Megatron-Bridge \
            --ref main \
            --field mcore_commit=${{ steps.mcore_info.outputs.sha }} \
            --field mcore_branch=${{ steps.mcore_info.outputs.branch }} \
            --field test_suite=${{ inputs.test_suite }} \
            --field triggered_by=mcore-ci
          
          echo "âœ… cicd-main.yml triggered successfully!"
      
      - name: Workflows triggered
        run: |
          echo "âœ… All selected workflows triggered successfully!"
          echo ""
          echo "ðŸ“Š View MBridge workflow runs:"
          if [ "${{ inputs.run_install_test }}" == "true" ]; then
            echo "  - install-test: https://github.com/NVIDIA/Megatron-Bridge/actions/workflows/install-test.yml"
          fi
          if [ "${{ inputs.run_cicd_main }}" == "true" ]; then
            echo "  - cicd-main: https://github.com/NVIDIA/Megatron-Bridge/actions/workflows/cicd-main.yml"
          fi
          echo ""
          echo "â³ The test results will appear in MBridge's Actions tab"
          echo "ðŸ’¡ Look for runs triggered by: mcore-ci"
      
      - name: Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ”„ MBridge Test Trigger Summary
          
          **MCore Commit:** \`${{ steps.mcore_info.outputs.short_sha }}\`  
          **Test Suite:** \`${{ inputs.test_suite }}\`  
          
          ### ðŸš€ Triggered Workflows
          
          EOF
          
          if [ "${{ inputs.run_install_test }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          - âœ… [install-test.yml](https://github.com/NVIDIA/Megatron-Bridge/actions/workflows/install-test.yml) - Quick install check (~5-10 min)
          EOF
          fi
          
          if [ "${{ inputs.run_cicd_main }}" == "true" ]; then
            cat >> $GITHUB_STEP_SUMMARY <<EOF
          - âœ… [cicd-main.yml](https://github.com/NVIDIA/Megatron-Bridge/actions/workflows/cicd-main.yml) - Full CI/CD with test suite: ${{ inputs.test_suite }} (~60-90 min)
          EOF
          fi
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          
          ### ðŸ“Š Next Steps
          
          1. View the triggered workflows in [MBridge Actions](https://github.com/NVIDIA/Megatron-Bridge/actions)
          2. Filter by "triggered by: mcore-ci" to find your runs
          3. Wait for test completion
          4. Review results for any breaking changes
          
          ### ðŸ”— Useful Links
          
          - [MBridge Repository](https://github.com/NVIDIA/Megatron-Bridge)
          - [MBridge Actions](https://github.com/NVIDIA/Megatron-Bridge/actions)
          EOF

