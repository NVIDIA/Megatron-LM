.build_rules:
  rules:
    - if: $BUILD == "no"
      when: never
    - when: on_success
  stage: test

.build_image:
  extends: [.build_rules, .dind_rules]
  stage: build
  tags:
    - arch/${PLATFORM}
    - origin/jet-fleet
    - env/prod
    - purpose/builder-large
  services:
    - name: docker:24.0.5-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2376"
  timeout: 180m
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    STAGE: jet
    MCORE_BACKWARDS_REF: core_r0.14.0
    KUBERNETES_SERVICE_MEMORY_REQUEST: 90Gi
    KUBERNETES_SERVICE_MEMORY_LIMIT: 90Gi
    SHARED_PATH: /builds/$CI_PROJECT_PATH/shared
  script:
    - eval PUBLISH_COMMIT=$PUBLISH_COMMIT
    - apk add bash curl git
    - export TE_GIT_REF=$TE_GIT_REF
    - export GH_TOKEN=$GH_TOKEN
    - bash .gitlab/scripts/build.sh

    - git fetch origin $MCORE_BACKWARDS_REF
    - MCORE_BACKWARDS_COMMIT=$(git rev-parse FETCH_HEAD)

    - echo "MCORE_MR_COMMIT=$CI_COMMIT_SHA" | tee -a build.env
    - echo "MCORE_BACKWARDS_COMMIT=$MCORE_BACKWARDS_COMMIT" | tee -a build.env
    - cat build.env
  retry:
    max: 2
  artifacts:
    reports:
      dotenv: build.env

test:pre_build_image:
  extends: [.build_image]
  parallel:
    matrix:
      - IMAGE: CI_MCORE_LTS_IMAGE
        FILE: Dockerfile.ci.dev
        IMAGE_TYPE: lts
        BASE_IMAGE: nvcr.io/nvidia/pytorch:25.09-py3
        PLATFORM: amd64
      - IMAGE: CI_MCORE_LTS_IMAGE
        FILE: Dockerfile.ci.dev
        IMAGE_TYPE: lts
        BASE_IMAGE: nvcr.io/nvidia/pytorch:25.09-py3
        PLATFORM: arm64
      - IMAGE: CI_MCORE_DEV_IMAGE
        FILE: Dockerfile.ci.dev
        IMAGE_TYPE: dev
        BASE_IMAGE: nvcr.io/nvidia/pytorch:25.11-py3
        PLATFORM: amd64
      - IMAGE: CI_MCORE_DEV_IMAGE
        FILE: Dockerfile.ci.dev
        IMAGE_TYPE: dev
        BASE_IMAGE: nvcr.io/nvidia/pytorch:25.11-py3
        PLATFORM: arm64
      - IMAGE: UTILITY_IMAGE
        FILE: Dockerfile.linting
        BASE_IMAGE: python:3.10
        PLATFORM: amd64
      - IMAGE: UTILITY_IMAGE
        FILE: Dockerfile.linting
        BASE_IMAGE: python:3.10
        PLATFORM: arm64

test:build_nemo_image:
  extends: [.build_image]
  variables:
    IMAGE: CI_NEMO_IMAGE
    FILE: Dockerfile.ci.nemo
    BASE_IMAGE: nvcr.io/nvidian/nemo:nightly
    PLATFORM: amd64
  rules:
    - if: $FUNCTIONAL_TEST == "yes" || $INTEGRATION_TEST == "yes" || $CI_COMMIT_BRANCH == "ci-rebuild-mcore-nemo-image"
      when: on_success

test:build_image:
  needs: [test:pre_build_image]
  extends: [.build_rules, .dind_rules]
  parallel:
    matrix:
      - IMAGE: CI_MCORE_LTS_IMAGE
      - IMAGE: CI_MCORE_DEV_IMAGE
      - IMAGE: UTILITY_IMAGE
  stage: build
  tags:
    - arch/amd64
    - origin/jet-fleet
    - env/prod
    - purpose/builder-large
  services:
    - name: docker:24.0.5-dind
      variables:
        HEALTHCHECK_TCP_PORT: "2376"
  timeout: 180m
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_TLS_VERIFY: 1
    DOCKER_CERT_PATH: "$DOCKER_TLS_CERTDIR/client"
    STAGE: jet
    MCORE_BACKWARDS_REF: core_r0.14.0
    KUBERNETES_SERVICE_MEMORY_REQUEST: 90Gi
    KUBERNETES_SERVICE_MEMORY_LIMIT: 90Gi
    SHARED_PATH: /builds/$CI_PROJECT_PATH/shared
  script:
    - |
      set -x

      env
      eval "IMAGE=\$$IMAGE"

      docker manifest create ${IMAGE}:${CI_PIPELINE_ID} \
        ${IMAGE}:${CI_PIPELINE_ID}-amd64 \
        ${IMAGE}:${CI_PIPELINE_ID}-arm64

      docker manifest push ${IMAGE}:${CI_PIPELINE_ID}
    - echo "MCORE_MR_COMMIT=$CI_COMMIT_SHA" | tee -a build.env
    - echo "MCORE_BACKWARDS_COMMIT=$MCORE_BACKWARDS_COMMIT" | tee -a build.env
    - cat build.env
  retry:
    max: 2
  artifacts:
    reports:
      dotenv: build.env
