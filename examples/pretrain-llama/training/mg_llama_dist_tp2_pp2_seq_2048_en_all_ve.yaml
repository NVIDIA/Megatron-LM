# Training job submission via AML CLI v2

$schema: https://azuremlschemas.azureedge.net/latest/commandJob.schema.json

command: >-
  python pretrain_gpt.py
  --tensor-model-parallel-size 2
  --pipeline-model-parallel-size 2
  --seq-length 2048
  --max-position-embeddings 2048
  --tokenizer-type Llama2Tokenizer
  --tokenizer-model ${{inputs.tokenizer}}
  --load ${{inputs.load_initial_model}}
  --exit-on-missing-checkpoint
  --use-checkpoint-args
  --no-initialization
  --no-load-optim
  --no-load-rng
  --bf16
  --untie-embeddings-and-output-weights
  --use-rotary-position-embeddings
  --normalization RMSNorm
  --no-position-embedding
  --no-masked-softmax-fusion
  --no-query-key-layer-scaling
  --micro-batch-size 2 
  --global-batch-size 1920
  --train-iters 3000
  --lr 0.0003 
  --lr-decay-style cosine 
  --min-lr 0.00003 
  --lr-warmup-iters 20 
  --weight-decay 0.1 
  --clip-grad 1.0 
  --save ${{outputs.model_dir}} 
  --data-cache-path ${{outputs.cache}}
  --split 9998,1,1 
  --log-interval 10
  --log-validation-ppl-to-tensorboard 
  --save-interval 200 
  --eval-interval 200 
  --eval-iters 100
  --tensorboard-dir ${{outputs.model_dir}}/tensorboard
  --tensorboard-log-interval 100
  --no-async-tensor-model-parallel-allreduce
  --use-flash-attn
  --data-path 0.008202137678638038 ${{inputs.data}}/ar_books_split_00_text_document 0.007231072724606678 ${{inputs.data}}/ar_books_split_01_text_document 0.0005905744362428366 ${{inputs.data}}/ar_encyclopedias_split_00_text_document 0.0031099016080125613 ${{inputs.data}}/ar_news_split_00_text_document 0.0034319294767788896 ${{inputs.data}}/ar_news_split_01_text_document 0.00362781227468757 ${{inputs.data}}/ar_news_split_02_text_document 0.0033799636920500307 ${{inputs.data}}/ar_news_split_03_text_document 0.00211959826679394 ${{inputs.data}}/ar_news_split_04_text_document 0.0010334955632060122 ${{inputs.data}}/ar_others_split_00_text_document 0.0006031550496223811 ${{inputs.data}}/ar_transcribed_split_00_text_document 0.0011163635827105322 ${{inputs.data}}/ar_translated_En_wikipedia_split_translated_split_00_text_document 0.0025004554908989217 ${{inputs.data}}/ar_web_arabicweb16_v2_split_00_text_document 0.0025217396732831825 ${{inputs.data}}/ar_web_arabicweb16_v2_split_01_text_document 0.002526541852265505 ${{inputs.data}}/ar_web_arabicweb16_v2_split_02_text_document 0.002510415903959214 ${{inputs.data}}/ar_web_arabicweb16_v2_split_03_text_document 0.0025163942820395514 ${{inputs.data}}/ar_web_arabicweb16_v2_split_04_text_document 0.0025244861666491813 ${{inputs.data}}/ar_web_arabicweb16_v2_split_05_text_document 0.002510931727367011 ${{inputs.data}}/ar_web_arabicweb16_v2_split_06_text_document 0.0025148361605953507 ${{inputs.data}}/ar_web_arabicweb16_v2_split_07_text_document 0.0025128344918845633 ${{inputs.data}}/ar_web_arabicweb16_v2_split_08_text_document 0.002517982074741723 ${{inputs.data}}/ar_web_arabicweb16_v2_split_09_text_document 0.0009811044904462411 ${{inputs.data}}/ar_web_arabicweb16_v2_split_10_text_document 0.00232768812455233 ${{inputs.data}}/ar_web_arabicweb22_split_00_text_document 0.0015757431282295668 ${{inputs.data}}/ar_web_arabicweb22_split_01_text_document 0.0025187771122950385 ${{inputs.data}}/ar_web_metadialog_split_00_text_document 0.0024991590851660512 ${{inputs.data}}/ar_web_metadialog_split_01_text_document 0.0025528412380482874 ${{inputs.data}}/ar_web_metadialog_split_02_text_document 0.002564260107558059 ${{inputs.data}}/ar_web_metadialog_split_03_text_document 0.002521037453511211 ${{inputs.data}}/ar_web_metadialog_split_04_text_document 0.0025013030237548005 ${{inputs.data}}/ar_web_metadialog_split_05_text_document 0.0025065419027903314 ${{inputs.data}}/ar_web_metadialog_split_06_text_document 0.0024919063645959497 ${{inputs.data}}/ar_web_metadialog_split_07_text_document 0.0024929014929401952 ${{inputs.data}}/ar_web_metadialog_split_08_text_document 0.0025005764583352634 ${{inputs.data}}/ar_web_metadialog_split_09_text_document 0.0025243659600143256 ${{inputs.data}}/ar_web_metadialog_split_10_text_document 0.0025134728043316747 ${{inputs.data}}/ar_web_metadialog_split_11_text_document 0.0007628297831890634 ${{inputs.data}}/ar_web_metadialog_split_12_text_document 0.002390435227145335 ${{inputs.data}}/ar_web_oscar2301_split_00_text_document 0.002391783367379282 ${{inputs.data}}/ar_web_oscar2301_split_01_text_document 4.5168023447640095e-${{inputs.data}}/05 ar_web_oscar2301_split_02_text_document 0.016130001095809008 ${{inputs.data}}/en_books_books_split_00_text_document 0.016133365359981985 ${{inputs.data}}/en_books_books_split_01_text_document 0.00014275983411896745 ${{inputs.data}}/en_books_books_split_02_text_document 0.013998806312358216 ${{inputs.data}}/en_code_github_split_00_text_document 0.013993570096127887 ${{inputs.data}}/en_code_github_split_01_text_document 0.013995647084185832 ${{inputs.data}}/en_code_github_split_02_text_document 0.014003175214894019 ${{inputs.data}}/en_code_github_split_03_text_document 0.0034090639685050916 ${{inputs.data}}/en_code_github_split_04_text_document 0.013718918857524295 ${{inputs.data}}/en_code_stackexchange_split_00_text_document 0.0067086562111283105 ${{inputs.data}}/en_code_stackexchange_split_01_text_document 0.06781623160088479 ${{inputs.data}}/en_encyclopedia_m_wikipedia_split_00_text_document 0.04341498466261673 ${{inputs.data}}/en_encyclopedia_m_wikipedia_split_01_text_document 0.005447999018502175 ${{inputs.data}}/en_encyclopedia_m_wikipedia_split_02_text_document 0.027933115678704646 ${{inputs.data}}/en_encyclopedia_wikipedia_split_00_text_document 0.013417609895637813 ${{inputs.data}}/en_reasoning_open-web-math_split_00_text_document 0.003025197013719808 ${{inputs.data}}/en_reasoning_open-web-math_split_01_text_document 0.011669427306502304 ${{inputs.data}}/en_reasoning_peS2o_split_00_text_document 0.012878496832738335 ${{inputs.data}}/en_reasoning_peS2o_split_01_text_document 0.013658444649371989 ${{inputs.data}}/en_reasoning_peS2o_split_02_text_document 0.013659519661872309 ${{inputs.data}}/en_reasoning_peS2o_split_03_text_document 0.013659152194754364 ${{inputs.data}}/en_reasoning_peS2o_split_04_text_document 0.013661083108926915 ${{inputs.data}}/en_reasoning_peS2o_split_05_text_document 0.013659951036315112 ${{inputs.data}}/en_reasoning_peS2o_split_06_text_document 0.013658232385757276 ${{inputs.data}}/en_reasoning_peS2o_split_07_text_document 0.013660030920471187 ${{inputs.data}}/en_reasoning_peS2o_split_08_text_document 0.013660003531617676 ${{inputs.data}}/en_reasoning_peS2o_split_09_text_document 0.006748271144526525 ${{inputs.data}}/en_reasoning_peS2o_split_10_text_document 0.017340259754768324 ${{inputs.data}}/en_scientific_arxiv_split_00_text_document 0.016333979582334752 ${{inputs.data}}/en_scientific_arxiv_split_01_text_document 0.004568987240320959 ${{inputs.data}}/en_web_c4_split_00_text_document 0.004570069860836143 ${{inputs.data}}/en_web_c4_split_01_text_document 0.004569280148893233 ${{inputs.data}}/en_web_c4_split_02_text_document 0.0045699808470622315 ${{inputs.data}}/en_web_c4_split_03_text_document 0.004569635443187394 ${{inputs.data}}/en_web_c4_split_04_text_document 0.004569233740002561 ${{inputs.data}}/en_web_c4_split_05_text_document 0.004569388182704305 ${{inputs.data}}/en_web_c4_split_06_text_document 0.00456943839560241 ${{inputs.data}}/en_web_c4_split_07_text_document 0.004569146247831622 ${{inputs.data}}/en_web_c4_split_08_text_document 0.004569635443187394 ${{inputs.data}}/en_web_c4_split_09_text_document 0.004569525887773348 ${{inputs.data}}/en_web_c4_split_10_text_document 0.0045695159973540254 ${{inputs.data}}/en_web_c4_split_11_text_document 0.004569141683022703 ${{inputs.data}}/en_web_c4_split_12_text_document 0.004569044300432441 ${{inputs.data}}/en_web_c4_split_13_text_document 0.004569888029280888 ${{inputs.data}}/en_web_c4_split_14_text_document 0.004569461219647002 ${{inputs.data}}/en_web_c4_split_15_text_document 0.000546753031426171 ${{inputs.data}}/en_web_c4_split_16_text_document 0.004584636926896747 ${{inputs.data}}/en_web_cc_split_00_text_document 0.004576471244542934 ${{inputs.data}}/en_web_cc_split_01_text_document 0.004598516989215108 ${{inputs.data}}/en_web_cc_split_02_text_document 0.004586809015140494 ${{inputs.data}}/en_web_cc_split_03_text_document 0.004577038802451808 ${{inputs.data}}/en_web_cc_split_04_text_document 0.004579291535653117 ${{inputs.data}}/en_web_cc_split_05_text_document 0.004609490029053833 ${{inputs.data}}/en_web_cc_split_06_text_document 0.004714023392487314 ${{inputs.data}}/en_web_cc_split_07_text_document 0.004717357224600834 ${{inputs.data}}/en_web_cc_split_08_text_document 0.004716743257801288 ${{inputs.data}}/en_web_cc_split_09_text_document 0.004712838063771462 ${{inputs.data}}/en_web_cc_split_10_text_document 0.0047155206498126 ${{inputs.data}}/en_web_cc_split_11_text_document 0.004717243865179356 ${{inputs.data}}/en_web_cc_split_12_text_document 0.004717698063666753 ${{inputs.data}}/en_web_cc_split_13_text_document 0.00464113632768322 ${{inputs.data}}/en_web_cc_split_14_text_document 0.0045902873995364345 ${{inputs.data}}/en_web_cc_split_15_text_document 0.004591136453995287 ${{inputs.data}}/en_web_cc_split_16_text_document 0.004604657418012054 ${{inputs.data}}/en_web_cc_split_17_text_document 0.0045880940088510675 ${{inputs.data}}/en_web_cc_split_18_text_document 0.004590659431463297 ${{inputs.data}}/en_web_cc_split_19_text_document 0.004591702490301187 ${{inputs.data}}/en_web_cc_split_20_text_document 0.0046047258901458325 ${{inputs.data}}/en_web_cc_split_21_text_document 0.004674053164794938 ${{inputs.data}}/en_web_cc_split_22_text_document 0.004736959274898606 ${{inputs.data}}/en_web_cc_split_23_text_document 0.004729161820464223 ${{inputs.data}}/en_web_cc_split_24_text_document 0.004730311391510213 ${{inputs.data}}/en_web_cc_split_25_text_document 0.004731474656982959 ${{inputs.data}}/en_web_cc_split_26_text_document 0.004736499750800804 ${{inputs.data}}/en_web_cc_split_27_text_document 0.004734668501622977 ${{inputs.data}}/en_web_cc_split_28_text_document 0.004727652390315154 ${{inputs.data}}/en_web_cc_split_29_text_document 0.0047315499763301155 ${{inputs.data}}/en_web_cc_split_30_text_document 0.00470025897199489 ${{inputs.data}}/en_web_cc_split_31_text_document 0.00457426872423973 ${{inputs.data}}/en_web_cc_split_32_text_document 0.004568664660490714 ${{inputs.data}}/en_web_cc_split_33_text_document 0.004573723990375449 ${{inputs.data}}/en_web_cc_split_34_text_document 0.004574309807519997 ${{inputs.data}}/en_web_cc_split_35_text_document 0.004574528157546601 ${{inputs.data}}/en_web_cc_split_36_text_document 0.00457420709931933 ${{inputs.data}}/en_web_cc_split_37_text_document 0.004568558148282615 ${{inputs.data}}/en_web_cc_split_38_text_document 0.004626184296070484 ${{inputs.data}}/en_web_cc_split_39_text_document 0.0046975999707998305 ${{inputs.data}}/en_web_cc_split_40_text_document 0.00470000562509991 ${{inputs.data}}/en_web_cc_split_41_text_document 0.004704243289379305 ${{inputs.data}}/en_web_cc_split_42_text_document 0.004701903824808544 ${{inputs.data}}/en_web_cc_split_43_text_document 0.004697726263846577 ${{inputs.data}}/en_web_cc_split_44_text_document 0.004697978089138584 ${{inputs.data}}/en_web_cc_split_45_text_document 0.004701852851108953 ${{inputs.data}}/en_web_cc_split_46_text_document 0.004706151379507261 ${{inputs.data}}/en_web_cc_split_47_text_document 0.004645168575561279 ${{inputs.data}}/en_web_cc_split_48_text_document 0.004541965853927558 ${{inputs.data}}/en_web_cc_split_49_text_document 0.004536998581022681 ${{inputs.data}}/en_web_cc_split_50_text_document 0.004534149379456015 ${{inputs.data}}/en_web_cc_split_51_text_document 0.004541702616613254 ${{inputs.data}}/en_web_cc_split_52_text_document 0.004537208562232935 ${{inputs.data}}/en_web_cc_split_53_text_document 0.00453743299867143 ${{inputs.data}}/en_web_cc_split_54_text_document 0.004533900597369953 ${{inputs.data}}/en_web_cc_split_55_text_document 0.004676789006940127 ${{inputs.data}}/en_web_cc_split_56_text_document 0.004683861417557945 ${{inputs.data}}/en_web_cc_split_57_text_document 0.004681912244149721 ${{inputs.data}}/en_web_cc_split_58_text_document 0.004679984373183117 ${{inputs.data}}/en_web_cc_split_59_text_document 0.004683705453253227 ${{inputs.data}}/en_web_cc_split_60_text_document 0.0046838834808010515 ${{inputs.data}}/en_web_cc_split_61_text_document 0.004681636073210148 ${{inputs.data}}/en_web_cc_split_62_text_document 0.004680057410125814 ${{inputs.data}}/en_web_cc_split_63_text_document 0.004532736571095721 ${{inputs.data}}/en_web_cc_split_64_text_document 0.004532385841610478 ${{inputs.data}}/en_web_cc_split_65_text_document 0.004534868336860687 ${{inputs.data}}/en_web_cc_split_66_text_document 0.004526647115998365 ${{inputs.data}}/en_web_cc_split_67_text_document 0.004531448534179201 ${{inputs.data}}/en_web_cc_split_68_text_document 0.004527910807267319 ${{inputs.data}}/en_web_cc_split_69_text_document 0.004534844752014608 ${{inputs.data}}/en_web_cc_split_70_text_document 0.004532654404535187 ${{inputs.data}}/en_web_cc_split_71_text_document 0.004547850653425065 ${{inputs.data}}/en_web_cc_split_72_text_document 0.004665403612695758 ${{inputs.data}}/en_web_cc_split_73_text_document 0.004672872400888004 ${{inputs.data}}/en_web_cc_split_74_text_document 0.004668490945127676 ${{inputs.data}}/en_web_cc_split_75_text_document 0.004671774564343091 ${{inputs.data}}/en_web_cc_split_76_text_document 0.00466782372222408 ${{inputs.data}}/en_web_cc_split_77_text_document 0.004668627128593746 ${{inputs.data}}/en_web_cc_split_78_text_document 0.004671735002665797 ${{inputs.data}}/en_web_cc_split_79_text_document 0.004668420190589438 ${{inputs.data}}/en_web_cc_split_80_text_document 0.0031239771963129334 ${{inputs.data}}/en_web_cc_split_81_text_document    

display_name: MegatronLM-Allam-V2-data_Experiment_tp2_pp2_seq2048_bs1976

experiment_name: MegatronLM-Vocab-Expansion
code: ../../../
environment: azureml:Megatron-LLaMA:4
environment_variables:
  HYDRA_FULL_ERROR: '1'
  UCX_IB_PCI_RELAXED_ORDERING: 'auto'
  NCCL_IB_PCI_RELAXED_ORDERING: '2'
  NCCL_IB_TIMEOUT: '22'
  NCCL_DEBUG: WARN
  CUDA_DEVICE_MAX_CONNECTIONS: '1'
inputs:
  load_initial_model:
    type: uri_folder
    mode: ro_mount
    path: azureml://subscriptions/c7209a17-0d9f-41df-8e45-e0172343698d/resourcegroups/LLM-Test/workspaces/Provisioning-Test/datastores/srashed/paths/vocab_expansion_assets/megatronlm_models/Llama-2-7b-hf-ExpTok-32K_10M_tp2_pp2_seq4096_gb48/
  tokenizer:
    type: uri_file
    mode: ro_mount
    path: azureml://subscriptions/c7209a17-0d9f-41df-8e45-e0172343698d/resourcegroups/llm-test/workspaces/Provisioning-Test/datastores/llama_pretraining/paths/allam_data_2-1_splits-llama2-VE-indexed_data/tokenizer/tokenizer.model
  data:
    type: uri_folder
    mode: ro_mount
    path: azureml://subscriptions/c7209a17-0d9f-41df-8e45-e0172343698d/resourcegroups/llm-test/workspaces/Provisioning-Test/datastores/llama_pretraining/paths/allam_data_2-1_splits-llama2-VE-indexed_data/bin_idx/
outputs:
  cache:
    type: uri_folder
    mode: rw_mount
    path: azureml://subscriptions/c7209a17-0d9f-41df-8e45-e0172343698d/resourcegroups/llm-test/workspaces/Provisioning-Test/datastores/sbmaruf/paths/vocab_expansion_assets/experiments/Llama-2-7b-hf-ExpTok-32K_10M_tp4_pp2_seq2048_en_all_gbs1920/cache
  model_dir:
    type: uri_folder
    mode: rw_mount
    path: azureml://subscriptions/c7209a17-0d9f-41df-8e45-e0172343698d/resourcegroups/llm-test/workspaces/Provisioning-Test/datastores/sbmaruf/paths/vocab_expansion_assets/experiments/Llama-2-7b-hf-ExpTok-32K_10M_tp4_pp2_seq2048_en_all_gbs1920/


services:
  my_jupyterlab:
    type: jupyter_lab
    nodes: all

compute: azureml:A100-SSH

distribution:
  type: pytorch
  process_count_per_instance: 8

resources:
  instance_count: 24
  shm_size: 800g