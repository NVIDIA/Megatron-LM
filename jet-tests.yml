.jet_common:
  stage: jet
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Run tests/'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Build only/'
    # If either $JET_CUSTOM_FILTER or both $CI_MODEL and $CI_TASK are provided
    - when: never

default:
  id_tokens:
    VAULT_JWT_TOKEN:
      aud: https://stg.vault.nvidia.com

include:
  - project: dl/jet/gitlab-templates
    ref: main
    file: downstreams.yml

jet-setup:
  extends: [ .jet_common ]
  tags: 
    - os/linux
  script:
    - set -x
    - JET_FILTER=${JET_CUSTOM_FILTER:-False}
    - echo "_JET_FILTER=$JET_FILTER" | tee -a config.env
  artifacts:
    reports:
      dotenv: config.env
  interruptible: true

jet-configure:
  image: gitlab-master.nvidia.com:5005/adlr/megatron-lm/ci_yq:v1
  extends: [.jet_common, .jet-configure]
  tags:
    - os/linux
  script:
    - |
      IMAGE=$CI_IMAGE yq -i '. |= 
        (select(.spec.name == "mcore-pyt") 
        | .spec.source.arguments.FROM_IMAGE_NAME = env(IMAGE))
      ' tests/functional_tests/jet_recipes/build-pyt.yaml

  artifacts:
    paths:
      - tests/functional_tests/jet_recipes
  interruptible: true
  
jet-trigger:
  stage: jet
  extends: [.jet_common, .jet-trigger]
  needs:  [ jet-configure, jet-setup ]
  trigger:
    project: dl/jet/ci
    branch: $JET_CLUSTER_BRANCH
    strategy: depend
  inherit:
    variables:
      - JET_CUSTOM_FILTER
      - JET_CLUSTER_BRANCH
  variables:
    JET_WORKLOADS_FILTER: "$_JET_FILTER"
  interruptible: true

jet-results-summary:
  stage: jet
  image: gitlab-master.nvidia.com:5005/dl/jet/api:latest
  tags:
    - os/linux
  needs: [ jet-trigger ]
  before_script:
    - jet secrets jwt-login jwt/nvidia/gitlab-master adlr-megatron-lm-ci $VAULT_JWT_TOKEN
  script: 
    - env
    - python -m pip install -U --no-cache-dir prettytable
    - rc=0
    - python tests/functional_tests/python_test_utils/jet_test_pipeline.py ${CI_PIPELINE_ID} --artifact_links $CI_JOB_ID --download_scripts_dir ./scripts || rc=$?
    - exit $rc
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_LABELS =~ /Run tests/'
      when: always
    - if: $JET_CUSTOM_FILTER != "" && $CI_PIPELINE_SOURCE != 'merge_request_event'
      when: always
    - when: never
  artifacts:
    when: always
    paths:
      - scripts
  interruptible: true