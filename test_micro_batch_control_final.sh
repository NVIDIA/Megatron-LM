#!/bin/bash

echo "=================================================================================="
echo "æœ€ç»ˆæµ‹è¯•ï¼šmicro_batchæ§åˆ¶åŠŸèƒ½åœ¨Pythonä»£ç ä¸­çš„å®ç°"
echo "=================================================================================="

echo "âœ… å·²å®Œæˆçš„ä¿®æ”¹æ€»ç»“:"
echo "1. åœ¨ megatron/training/arguments.py ä¸­æ·»åŠ äº† --collect-micro-batches å‚æ•°"
echo "2. åœ¨ megatron/core/tensor_saver.py ä¸­æ›´æ–°äº†å‚æ•°è·å–é€»è¾‘"
echo "3. åœ¨ shell è„šæœ¬ä¸­æ·»åŠ äº†ç¯å¢ƒå˜é‡è®¾ç½®"
echo "4. åœ¨æ‰€æœ‰pipelineå‡½æ•°ä¸­æ·»åŠ äº†micro_batchæ§åˆ¶é€»è¾‘"
echo "5. æ›´æ–°äº†æ‰€æœ‰ç›¸å…³çš„å¸®åŠ©ä¿¡æ¯å’Œæ–‡æ¡£"
echo ""

echo "ğŸ”§ å‚æ•°è¯´æ˜:"
echo "- --control-iter: æ§åˆ¶æ”¶é›†å¤šå°‘ä¸ª micro_batch çš„æ•°æ®ï¼ˆæœ€å¤§é™åˆ¶ï¼‰"
echo "- --collect-micro-batches: æ”¶é›†çš„ micro_batch æ•°é‡ï¼ˆå®é™…æ”¶é›†æ•°é‡ï¼‰"
echo ""

echo "ğŸ“ ä½¿ç”¨ç¤ºä¾‹:"
echo ""
echo "1. åŸºæœ¬ç”¨æ³•ï¼ˆé»˜è®¤å‚æ•°ï¼‰:"
echo "   ./run_tensor_collection.sh single mxfp8"
echo "   # æ”¶é›†1ä¸ªmicro_batch"
echo ""
echo "2. è‡ªå®šä¹‰æ”¶é›†çš„micro_batchæ•°é‡:"
echo "   ./run_tensor_collection.sh --mode single --quant-type mxfp8 --control-iter 3"
echo "   # æ”¶é›†3ä¸ªmicro_batch"
echo ""
echo "3. è‡ªå®šä¹‰æ”¶é›†çš„micro_batchæ•°é‡:"
echo "   ./run_tensor_collection.sh --mode single --quant-type mxfp8 --collect-micro-batches 2"
echo "   # æ”¶é›†2ä¸ªmicro_batch"
echo ""
echo "4. åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªå‚æ•°:"
echo "   ./run_tensor_collection.sh --mode single --quant-type mxfp8 --control-iter 3 --collect-micro-batches 2"
echo "   # æ”¶é›†2ä¸ªmicro_batchï¼Œæœ€å¤š3ä¸ªiteration"
echo ""
echo "5. é€šè¿‡ä¸»è„šæœ¬ä½¿ç”¨:"
echo "   ./run_tensor_draw.sh --mode collect --quant-type mxfp8 --control-iter 2 --collect-micro-batches 1"
echo "   # æ”¶é›†1ä¸ªmicro_batchï¼Œæœ€å¤š2ä¸ªiteration"
echo ""

echo "ğŸ¯ ä¸»è¦æ”¹è¿›:"
echo "- é¿å…å‚æ•°å†²çªï¼šä½¿ç”¨ --collect-micro-batches è€Œä¸æ˜¯ --micro-batch-size"
echo "- æ›´æ¸…æ™°çš„å‘½åï¼šå‚æ•°åæ›´æ¸…æ¥šåœ°è¡¨è¾¾äº†å…¶ç”¨é€”"
echo "- ä¿æŒå…¼å®¹æ€§ï¼šä¸å½±å“ Megatron-LM åŸæœ‰çš„ --micro-batch-size å‚æ•°"
echo "- æ›´ç²¾ç¡®çš„æ§åˆ¶ï¼šå¯ä»¥åŒæ—¶æ§åˆ¶æ”¶é›†æ•°é‡å’Œæœ€å¤§é™åˆ¶"
echo "- å®Œæ•´çš„pipelineæ”¯æŒï¼šåœ¨æ‰€æœ‰pipelineå‡½æ•°ä¸­éƒ½æ·»åŠ äº†æ§åˆ¶é€»è¾‘"
echo ""

echo "ğŸ” éªŒè¯ä¿®æ”¹:"
echo "1. æ£€æŸ¥å‚æ•°å®šä¹‰:"
grep -n "collect-micro-batches" megatron/training/arguments.py
echo ""
echo "2. æ£€æŸ¥å‚æ•°ä½¿ç”¨:"
grep -n "collect_micro_batches" megatron/core/tensor_saver.py
echo ""
echo "3. æ£€æŸ¥ç¯å¢ƒå˜é‡è®¾ç½®:"
grep -n "COLLECT_MICRO_BATCHES" run_tensor_collection.sh
echo ""
echo "4. æ£€æŸ¥pipelineæ§åˆ¶é€»è¾‘:"
grep -n "increment_micro_batch" megatron/core/pipeline_parallel/schedules.py
echo ""
echo "5. æ£€æŸ¥æå‰é€€å‡ºé€»è¾‘:"
grep -n "should_continue_collection" megatron/core/pipeline_parallel/schedules.py
echo ""

echo "=================================================================================="
echo "æµ‹è¯•å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½éƒ½å·²æ­£ç¡®å®ç°å¹¶åœ¨Pythonä»£ç ä¸­å‘æŒ¥ä½œç”¨ã€‚"
echo "=================================================================================="
