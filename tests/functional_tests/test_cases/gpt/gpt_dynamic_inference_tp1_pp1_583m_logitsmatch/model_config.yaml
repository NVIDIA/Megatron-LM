ENV_VARS:
  CUDA_DEVICE_MAX_CONNECTIONS: 1
  NVTE_ALLOW_NONDETERMINISTIC_ALGO: 0
  NCCL_ALGO: Ring
  CUBLAS_WORKSPACE_CONFIG: :4096:8
TEST_TYPE: frozen-start
MODE: inference
MODEL_ARGS:
  --tiktoken-pattern: v2
  --use-mcore-models: true
  --tokenizer-type: TikTokenizer
  --tokenizer-model: ${DATA_PATH}/mcore_mistral/tokenizer/multiMixV8.gpt4o_nc_sd.500000.128k.vocab.json
  --auto-detect-ckpt-format: true
  --max-tokens-to-oom: 3600000
  --inference-max-seq-length: 4096
  --attention-backend: flash
  --use-checkpoint-args: true
  --micro-batch-size: 1
  --no-load-optim: true
  --no-use-tokenizer-model-from-checkpoint-args: true
  --timing-log-level: 2
  --load: ${CHECKPOINT_LOAD_PATH}/mcore_mistral/model
  --distributed-backend: nccl
  --log-interval: 1
  --transformer-impl: transformer_engine
  --tensor-model-parallel-size: 1
  --pipeline-model-parallel-size: 1
  --deterministic-mode: true
  --ckpt-format: torch_dist
  --dist-ckpt-save-pre-mcore-014: true
  --bf16: true
  --log-memory-to-tensorboard: true
  --log-num-zeros-in-grad: true
  --log-validation-ppl-to-tensorboard: true
  --log-timers-to-tensorboard: true
  --num-layers: 24
  --hidden-size: 1152
  --num-attention-heads: 16
  --max-position-embeddings: 1024
  --seq-length: 1024
  --temperature: 1.0
  --top_k: 1
  --return-log-probs: true
  --inference-dynamic-batching-max-requests-override: 8 # hardcode decode padding tokens to 7 for reproducibility
  --inference-dynamic-batching-buffer-guaranteed-fraction: 0.05
  --inference-dynamic-batching-buffer-overflow-factor: 1.2
  --inference-dynamic-batching-buffer-size-gb: 20
  --dist-ckpt-strictness: log_unexpected
  --inference-ckpt-non-strict: true # To handle the extra_state errors
  --output-path: ${TENSORBOARD_PATH}
  --output-every-n-results: 32
  --prompt-file: ${DATA_PATH}/sharegpt/filtered-benchmark/processed.jsonl
  --prompt-file-num-truncate: 128 # originally 1024
  --num-tokens-to-generate: 128 # originally 512
  --incoming-requests-per-step: 32
  --termination-id: -1
METRICS:
  - "generated_tokens"
  - "logprobs"
