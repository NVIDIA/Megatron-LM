type: basic
format_version: 1
maintainers: [mcore]
loggers: [stdout]
spec:
  name: "{test_case}_{environment}_{platforms}"
  model: gpt
  build: mcore-pyt-{environment}
  nodes: 1
  gpus: 8
  n_repeat: 5
  platforms: dgx_a100
  script_setup: |
    unset https_proxy
    echo "machine gitlab-master.nvidia.com login okoenig password $RO_API_TOKEN" | tee -a /root/.netrc

    # Checkout latest
    cd /opt
    rm -rf /opt/megatron-lm; mkdir megatron-lm; cd megatron-lm
    git init
    git remote add origin $MCORE_REPO
    git fetch origin '+refs/merge-requests/*:refs/remotes/merge-requests/*'
    git fetch origin $MCORE_MR_COMMIT
    git checkout $MCORE_MR_COMMIT
    git rev-parse HEAD

    # Checkout backwards-ref
    cd /opt
    rm -rf /opt/megatron-lm-legacy; mkdir megatron-lm-legacy; cd megatron-lm-legacy
    git init
    git remote add origin $MCORE_REPO
    git fetch origin $MCORE_BACKWARDS_COMMIT
    git checkout $MCORE_BACKWARDS_COMMIT
    git rev-parse HEAD
    rm -rf megatron; cp -a /opt/megatron-lm/megatron ./
  script: |-
    ls
    cd /opt/megatron-lm

    NAME=$(echo {test_case}_{environment} | sed 's/dgx_h100/dgx_a100/g')

    ARGUMENTS=(
        "DATA_PATH=/mnt/artifacts"
        "DATA_CACHE_PATH=/workspace/data/cache"
        "OUTPUT_PATH={assets_dir}"
        "TENSORBOARD_PATH={assets_dir}/tensorboard"
        "CHECKPOINT_SAVE_PATH={artifacts_dir}/checkpoints"
        "CHECKPOINT_LOAD_PATH=/mnt/artifacts/"
        "TRAINING_SCRIPT_PATH=pretrain_gpt.py"
        "TRAINING_PARAMS_PATH=./tests/functional_tests/test_cases/{model}/{test_case}/model_config.yaml"
        "GOLDEN_VALUES_PATH=./tests/functional_tests/test_cases/{model}/{test_case}/golden_values_{environment}_$CLUSTER.json"
        "N_REPEAT={n_repeat}"
        "ENABLE_LIGHTWEIGHT_MODE=${{ENABLE_LIGHTWEIGHT_MODE}}"
        "RECORD_CHECKPOINTS=${{RECORD_CHECKPOINTS}}"
    )

    bash ./tests/functional_tests/shell_test_utils/run_ci_test.sh ${{ARGUMENTS[@]}}

products:
  #######################################################################
  # Nightly tests: Run both DEV and LTS unless something is flaky       #
  #######################################################################
  - test_case: [gpt3_mcore_tp1_pp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce_param_gather]
    products:
      - environment: [dev]
        scope: [nightly]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_tp1_pp2]
    products:
      - environment: [lts]
        scope: [nightly]
      - environment: [dev]
        scope: [nightly]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_tp1_pp2_resume_torch_dist]
    products:
      - environment: [dev, lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_tp1_pp4]
    products:
      - environment: [lts]
        scope: [nightly]
      - environment: [dev]
        scope: [nightly]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_tp1_pp4_resume_torch_dist]
    products:
      - environment: [dev, lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_tp4_pp1_resume_torch]
    products:
      - environment: [lts]
        scope: [nightly]
      - environment: [dev]
        scope: [nightly]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_tp4_pp1_resume_torch_dist]
    products:
      - environment: [lts]
        scope: [nightly]
      - environment: [dev]
        scope: [nightly]
        platforms: [dgx_h100]
  #######################################################################
  # mr, mr-github tests: Mostly DEV on mr, mr-github, and LTS on nightly cadence, except for  #
  #             some very important tests.                              #
  #######################################################################
  - test_case: [gpt3_mcore_te_tp1_pp1_dist_optimizer_no_mmap_bin_files]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp1_resume_torch_dist_dist_optimizer]
    products:
      - environment: [dev]
        scope: [mr, mr-github-broken]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp1_resume_torch_dist_uniform_full_recompute]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  # - test_case: [gpt3_mcore_te_tp1_pp2_resume_torch_dist_cp4_a2a_p2p_nondeterministic]
  #   products:
  #     - environment: [dev]
  #       scope: [mr, mr-github]
  #     - environment: [lts]
  #       scope: [nightly] # Non-deterministic: #487
  - test_case: [gpt3_mcore_te_tp1_pp2_resume_torch_dist_rope_embeddings]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # outdated TE: #501
  - test_case: [gpt3_mcore_te_tp1_pp2_resume_torch_dist_rope_embeddings_interleaved_no_fusion]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_resume_torch_dist_disable_bias_linear]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # non-determinism: #436
  - test_case: [gpt3_mcore_te_tp1_pp4_resume_torch_dist_persistent_disable_bias_linear]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_resume_torch_dist_swiglu]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # non-determinism: #437
  - test_case: [gpt3_mcore_te_tp1_pp4_resume_torch_dist_untie_embeddings_and_outputs]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_decoupled_lr]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist_calculate_per_token_loss]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
      # - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist]
      #   products:
      #     - environment: [dev]
      #       scope: [mr, mr-github]
      #       platforms: [dgx_h100] # Hangs: #513
      # - environment: [lts]
      #   scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce_param_gather]
    products:
      # - environment: [dev]
      #   scope: [mr, mr-github]
      #   platforms: [dgx_h100] # Hangs: #513
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce_untied]
    products:
      # - environment: [dev]
      #   scope: [mr, mr-github] # Hangs: #513
      #   platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_resume_torch_dist_tunable_overlap]
    products:
      # - environment: [dev]
      #   scope: [mr, mr-github] # Hangs: #513
      #   platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_tunable_overlap]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_uneven_pipeline]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp2_account_for_embedding_loss_in_pipeline_split]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp1_resume_torch_dist_cp2_nondeterministic]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp1_resume_torch_dist_multi_dist_optimizer_instances]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_etp4_dp_last]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_calculate_per_token_loss]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_etp4_calculate_per_token_loss_dp_last]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_nondeterministic]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_etp4_nondeterministic_dp_last]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_calculate_per_token_loss_nondeterministic]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_cp2_etp4_calculate_per_token_loss_nondeterministic_dp_last]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_cross_entropy_loss_fusion]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]

  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_cp2_nondeterministic]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_cross_entropy_loss_fusion]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_mla]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_ddp_average_in_collective]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_defer_embedding_wgrad_compute]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_no_create_attention_mask_in_dataloader]
    products:
      # - environment: [dev]
      #   scope: [mr, mr-github] # Hangs: #513
      #   platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp2_resume_torch_dist_reshard_1x4xNone]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp4_pp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_te_tp4_pp1_resume_torch_dist_qk_layernorm_test_mode]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_mcore_tp2_pp2_uninstall_te]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [nightly]
  - test_case: [gpt3_7b_tp1_pp4_memory_speed]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # OOM: #434
  - test_case: [gpt3_7b_tp4_pp1_memory_speed]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # OOM: #434
  - test_case: [gpt3_mcore_te_tp2_zp_z3_resume_fsdp_dtensor]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly]
  - test_case: [gpt3_mcore_te_tp2_pp1_modelopt_distill_resume]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly] # Outdated: #502
  # - test_case: [gpt3_mcore_te_tp2_pp1_fsdp2_resume_torch_dist]
  #   products:
  # - environment: [dev]
  #   scope: [mr, mr-github] # Broken: #484
  # - environment: [lts]
  #   scope: [nightly] # Requires PyT 2.4: #481
  #######################################################################
  # Super important mr, mr-github tests that run for both DEV and LTS per mr, mr-github       #
  #######################################################################
  - test_case: [gpt3_mcore_reruns_persistent_1]
    products:
      - environment: [dev]
        scope: [mr, mr-github-broken]
        platforms: [dgx_h100]
      # - environment: [lts]
      #   scope: [nightly]
  # - test_case: [gpt3_mcore_reruns_persistent_2]
  #   products:
  # - environment: [dev]
  #   scope: [mr, mr-github]
  #   platforms: [dgx_h100]
  # - environment: [lts]
  #   scope: [nightly]
  - test_case: [gpt3_mcore_te_tp1_pp4_vp1_dist_optimizer_overlap_grad_reduce_param_gather_overlap_optimizer]
    products:
      - environment: [lts]
        scope: [mr, mr-github]
      - environment: [dev]
        scope: [mr, mr-github, mr-slim]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp4_pp1_dist_optimizer_overlap_grad_reduce_param_gather]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [mr, mr-github]
  - test_case: [gpt3_mcore_te_tp4_pp1_resume_torch_dist_dist_optimizer_overlap_grad_reduce_param_gather]
    products:
      - environment: [lts]
        scope: [mr, mr-github]
      - environment: [dev]
        scope: [mr, mr-slim]
        platforms: [dgx_h100]
  - test_case: [gpt3_mcore_te_tp4_pp2_resume_torch_dist_reshard_8x1xNone]
    products:
      - environment: [dev]
        scope: [mr, mr-github]
        platforms: [dgx_h100]
      - environment: [lts]
        scope: [mr, mr-github]
  # - test_case: [gpt3_mcore_te_tp4_pp2_frozen_resume_torch_dist_reshard_8x1xNone]
  #   products:
  #     - environment: [dev]
  #       scope: [mr, mr-github]
  #       platforms: [dgx_h100]
  # - test_case: [gpt3_mcore_te_tp1_pp1_frozen_resume_torch_dist_dist_optimizer]
  #   products:
  #     - environment: [dev]
  #       scope: [mr, mr-github]
  #       platforms: [dgx_h100]
  # - test_case: [gpt3_mcore_te_tp1_pp4_frozen_resume_torch_dist_swiglu]
  #   products:
  #     - environment: [dev]
  #       scope: [mr, mr-github]
  #       platforms: [dgx_h100]
  # - test_case: [gpt3_mcore_te_tp2_pp1_frozen_resume_torch_dist_cp2_nondeterministic]
  #   products:
  #     - environment: [dev]
  #       scope: [mr, mr-github]
  #       platforms: [dgx_a100, dgx_h100]
  # - test_case: [gpt3_weekly_dgx_b200_mcore_tp2_pp2_current_scaling_native_fp8_tp_pp_sp_tp_overlap]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_b200]
  # - test_case: [gpt3_weekly_dgx_b200_mcore_tp4_cp2_current_scaling_native_fp8_tp_fsdp]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_b200]
  # - test_case: [gpt3_weekly_dgx_b200_mcore_tp4_cp2_current_scaling_native_fp8_tp_sp_cp_tp_overlap]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_b200]
  # - test_case: [gpt3_weekly_dgx_b200_mcore_tp4_cp2_mxfp8_tp_sp_cp]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_b200]
  # - test_case: [gpt3_weekly_dgx_b200_mcore_tp4_cp2_native_fp8_tp_sp_cp_tp_overlap]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_b200]
  - test_case: [gpt3_weekly_dgx_h100_mcore_tp2_pp2_current_scaling_native_fp8_tp_pp_sp_tp_overlap]
    products:
      - environment: [dev]
        scope: [weekly]
        platforms: [dgx_h100]
  # - test_case: [gpt3_weekly_dgx_h100_mcore_tp4_cp2_current_scaling_native_fp8_tp_fsdp]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_h100]
  # - test_case: [gpt3_weekly_dgx_h100_mcore_tp4_cp2_current_scaling_native_fp8_tp_sp_cp_tp_overlap]
  #   products:
  #     - environment: [dev]
  #       scope: [weekly]
  #       platforms: [dgx_h100]
  - test_case: [gpt3_weekly_dgx_h100_mcore_tp4_cp2_native_fp8_tp_sp_cp_tp_overlap]
    products:
      - environment: [dev]
        scope: [weekly]
        platforms: [dgx_h100]
  # - test_case: [gpt3_mcore_tp2_pp2_resume_torch_dist_uninstall_te]
  #   products:
  #     - environment: [dev, lts]
  #       scope: [mr, mr-github] # Non-deterministic: #483
