type: basic
format_version: 1
maintainers: [mcore]
loggers: [stdout]
spec:
  name: '{test_case}_{environment}_{platforms}'
  model: moe2.0
  build: mcore-pyt-{environment}
  nodes: 1
  gpus: 8
  n_repeat: 5
  platforms: dgx_a100
  script_setup: |
    unset https_proxy
    echo "machine gitlab-master.nvidia.com login okoenig password $RO_API_TOKEN" | tee -a /root/.netrc

    # Checkout latest
    cd /opt
    rm -rf /opt/megatron-lm; mkdir megatron-lm; cd megatron-lm
    git init
    git remote add origin $MCORE_REPO
    git fetch origin '+refs/merge-requests/*:refs/remotes/merge-requests/*'
    git fetch origin $MCORE_MR_COMMIT
    git checkout $MCORE_MR_COMMIT
    git rev-parse HEAD

    # Checkout backwards-ref
    cd /opt
    rm -rf /opt/megatron-lm-legacy; mkdir megatron-lm-legacy; cd megatron-lm-legacy
    git init
    git remote add origin $MCORE_REPO
    git fetch origin $MCORE_BACKWARDS_COMMIT
    git checkout $MCORE_BACKWARDS_COMMIT
    git rev-parse HEAD
    rm -rf megatron; cp -a /opt/megatron-lm/megatron ./
  script: |-
    ls
    cd /opt/megatron-lm

    NAME=$(echo {test_case}_{environment} | sed 's/dgx_h100/dgx_a100/g')

    mkdir -p $(dirname ./tests/functional_tests/test_cases/{model}/{test_case}/model_config.yaml)
    python ./tests/test_utils/python_scripts/merge_config.py \
      --base_config ./tests/functional_tests/test_cases/ci_base_config.yml \
      --model_config ./tests/functional_tests/test_cases/{model}/model_configs/{model_config}.yaml \
      --runtime_config ./tests/functional_tests/test_cases/{model}/runtime_configs/{runtime_config}.yaml \
      --output_config ./tests/functional_tests/test_cases/{model}/{test_case}/model_config.yaml

    ARGUMENTS=(
        "DATA_PATH=/mnt/artifacts"
        "DATA_CACHE_PATH=/workspace/data/cache"
        "OUTPUT_PATH={assets_dir}"
        "TENSORBOARD_PATH={assets_dir}/tensorboard"
        "CHECKPOINT_SAVE_PATH={artifacts_dir}/checkpoints"
        "CHECKPOINT_LOAD_PATH=/mnt/artifacts"
        "TRAINING_SCRIPT_PATH=pretrain_gpt.py"
        "TRAINING_PARAMS_PATH=./tests/functional_tests/test_cases/{model}/{test_case}/model_config.yaml"
        "GOLDEN_VALUES_PATH=./tests/functional_tests/test_cases/{model}/golden_values/{test_case}/golden_values_{environment}_{platforms}.json"
        "N_REPEAT={n_repeat}"
        "ENABLE_LIGHTWEIGHT_MODE=${{ENABLE_LIGHTWEIGHT_MODE}}"
        "RECORD_CHECKPOINTS=${{RECORD_CHECKPOINTS}}"
    )

    bash ./tests/functional_tests/shell_test_utils/run_ci_test.sh ${{ARGUMENTS[@]}}

products:
  ###########################
  # DSv3 model tests        #
  ###########################
  - test_case: [dsv3_tp1pp1ep8]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp1pp1ep8
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  - test_case: [dsv3_tp2pp2ep4]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp2pp2ep4
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # FP8 training test
  - test_case: [dsv3_tp2pp2ep4_fp8]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp2pp2ep4_fp8
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # Scoped CUDA graphs test
  - test_case: [dsv3_tp2pp2ep4_cudagraph]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp2pp2ep4_cudagraph
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # Fine-grained activation offloading test
  - test_case: [dsv3_tp2pp2ep4_offloading]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp2pp2ep4_offloading
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # A2A communication overlap test
  - test_case: [dsv3_tp2pp2ep4_a2aOverlap]
    products:
      - model_config: dsv3_proxy
        runtime_config: tp2pp2ep4_a2aOverlap
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]

  ###########################
  # Qwen3 model tests       #
  ###########################
  - test_case: [qwen3_tp1pp1ep8]
    products:
      - model_config: qwen3_proxy
        runtime_config: tp1pp1ep8
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  - test_case: [qwen3_tp2pp2ep4]
    products:
      - model_config: qwen3_proxy
        runtime_config: tp2pp2ep4
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # Muon optimizer with allgather dispatcher test
  - test_case: [qwen3_tp1pp1ep8_muon]
    products:
      - model_config: qwen3_proxy
        runtime_config: tp1pp1ep8_muon
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
  # Context parallelism test
  - test_case: [qwen3_tp2pp2ep4_cp]
    products:
      - model_config: qwen3_proxy
        runtime_config: tp2pp2ep4_cp
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]

  ###########################
  # Qwen3-next model tests  #
  ###########################
  # Gated Delta Net (Linear Attention) test
  - test_case: [qwen3next_tp2pp2ep4]
    products:
      - model_config: qwen3next_proxy
        runtime_config: tp2pp2ep4
        environment: [dev]
        scope: [mr-github]
        platforms: [dgx_h100]
